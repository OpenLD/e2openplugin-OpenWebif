#from urllib import quote
#from Plugins.Extensions.OpenWebif.local import tstrings
#from json import dumps
#from time import localtime, strftime, mktime
#from Plugins.Extensions.OpenWebif.controllers.views.ajax.renderevtblock import renderEvtBlock
<style>
	table { font-family: Verdana; font-size: 11px; }
	tr { vertical-align: top }
	.float { float:left }
	.service { font-weight: bold; font-size: 12px; line-height:30px; padding-right: 4px; white-space: nowrap; overflow: hidden; width: 184px}
	.service img { width:50px; height:30px; float:left; margin-right:10px; border: 0;}
	.title { font-weight: bold;}
	.desc { font-size: 10px; line-height: 1.25em; max-height: 3.75em; overflow: hidden; }
	.event { cursor: pointer; width: 190px; overflow:hidden; margin-bottom: 0.75ex;}
	.bq { font-size: 11px; font-weight: bold; padding: 2px 4px; line-height: 18px; cursor: pointer; white-space: nowrap; display: inline-block; margin: 1px 1px 0px 0px;}
	.plus { font-size: 13px; font-weight: bold; padding: 2px 4px; line-height: 21px; cursor: pointer; white-space: nowrap; }
	.timer { font-weight: bold; font-size: 10px; }
	#eventdescription { width: 375px; height: auto; position: fixed; top: 205px; left: 350px; z-index: 100; display: none; overflow: auto; }
	#navepg { margin-bottom: 1px; }
	#tbl1 thead tr, #tbl1 tfoot tr { display: block; width: 100%; }
	#tbl1 tbody { width: 100%; height: 100%; overflow-y: auto; display: block; overflow-x: hidden;}
	.ui-widget-content.nobg , .ui-widget-header.nobg{ background-image: none; } 
	.wrapper { overflow-x: auto; width: 100%; -ms-overflow-style: -ms-autohiding-scrollbar;}
	td.border { width: 190px; }
</style>

<div id="navepg">
#for $slot in range(0,7)
	<div class="float plus ui-state-default #if $slot==$day then 'ui-state-active' else '' #" data-day="$(slot)">$tstrings[("day_" + (time.strftime("%w", time.localtime(time.time()+86400*slot))))]</div>
#end for
<div id="compressmepg" onclick="CompressMEPG();"><i id="compressmepgi" class="fa fa-compress link" aria-hidden="true"></i></div>
<div id="refreshmepg" onclick="RefreshMEPG();"><i id="refreshmepgi" class="fa fa-refresh link" aria-hidden="true"></i></div>
	<br clear="all">

#for $bq in $bouquets
	<div class="float bq ui-state-default #if $bq[0]==$bref then 'ui-state-active' else '' #" data-ref="$quote($bq[0])">$bq[1]</div>
#end for
<br clear="all">
</div>

#if $mode == 2

<style>
.channel-listing { white-space: normal;display:table;list-style:none;counter-reset:n 0;padding: 0;}
.channel-listing > li { display: block; white-space: nowrap; width: 16380px; overflow: hidden; font-size: 0px; vertical-align: top;}
.channel-listing > li > span { position: absolute; left: 0px; z-index: 2; border-width: 0px; width: 140px;white-space: nowrap; }
.channel-listing > li > span > div { vertical-align: top; height:50px;}
.channel-listing > li > span > div > span { font-size: 10px; display:inherit; }
.picon { display: inline-block; margin:0; max-width: 100px;}
.picon > img { max-height: 30px;}

.eventlist { display: inline-block; list-style-type: none; margin: 0px; padding: 1px 0px; width: calc(100% - 105px); }
.event { display: block; position: relative; vertical-align: top; clear: left; border: none; }
.event a,.event > span { padding: 0 0 0 10px; height:48px; width:100%; display: block; white-space: normal; overflow: hidden; }
.event a:link:hover { text-decoration: none; }
.ename { display: block; width: 100%; float: left; font-weight: 200; line-height: 1,4; font-size: 14px; }
.etime { display: inline-block; padding-right: 20px; font-weight: 200; line-height: 1,4; font-size: 12px; }
.event { display: inline-block; border-width: 0px 0px 0px 1px; }
.event .ename,.event .etime { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.timetable { border:none; height: 1px;}
.timetable > div { display:table; margin:0; padding:0;}
.timetable-now { position: relative;top: 0;left: 0;z-index: 1;width: 2px;height: 100%;background-color: #0fb8fb;float:left;}

</style>

#set $now = $mktime($localtime())

#if $day == 0
#set $first = $now - 3600
#else
#set $first = $now + ($day * 3600 * 24) 
#end if

#set $s = $strftime("%S",$localtime($first))
#set $m = $strftime("%M",$localtime($first))
#set $offset = $int($m) * 60
#set $offset = $offset + $int($s)

#if $day > 0
#set $h = $strftime("%H",$localtime($first))
#set $offset = $offset + $int($h) * 60 * 60
#set $offset = $offset + 3600
#end if

#set $first = $first - $offset

#end if

#if $mode == 1
#set $renderEventBlock = $renderEvtBlock()
<div class="wrapper">
<table border="0" cellpadding="0" cellspacing="0" width="100%" id="tbl1">
<thead>
<tr>
	#for $sname, $eventlist in $events.iteritems()
	<td class="border"><div class="service ui-widget-header"><img src="$(picons[$sname])" /> $sname</div></td>
	#end for
</tr>
</thead>
<tbody id="tbl1body">
	#set hasEvents = False
	#for $slot in range(0,12)
	<tr class="$(slot%2 and 'ui-widget-content' or 'ui-widget-content ui-state-hover') nobg">
		#for $sname, $eventlist in $events.iteritems()
		<td class="border">
			#for $event in $eventlist[$slot]
				$renderEventBlock.render($event)
				#set hasEvents = True
			#end for
		</td>
		#end for
	</tr>
	#end for
</tbody>
<tfoot>
<tr>
	#for $sname, $eventlist in $events.iteritems()
	<td class="border"><div class="service ui-widget-header"><img src="$(picons[$sname])" /> $sname</div></td>
	#end for
</tr>
</tfoot>
</table>
#else
<div class="wrapper">
<div id="tbl1body" style="position: relative; width: 100%;">
	<div id="tblinner" style="height: auto;width: 100%; white-space: nowrap;">
	<div class="timetable">
	<div>
	<div class="timetable-now"></div>
	</div>
	</div>

	<ol class="channel-listing ui-widget-header nobg" style="border:none;">
		<li>
			<span>
				<div>
					<h2 class="picon" ></h2>
					<span></span>
				</div>
			</span>
			<ol cass="eventlist">
				#set pad = 141
				<li class="event" style="width:${pad}px;">
				</li>
				#for $slot in range(0,50)
					#set $t = $first + ($slot * 3600)
					<li class="event" style="width:600px;" >
						<span class="ui-widget-header nobg">
							<span class="ename">$strftime("%H:%M", $localtime($t))</span>
							<span class="etime">
								<span>$strftime("%A / %e / %B", $localtime($t))</span>
							</span>
						</span>
					</li>
				#end for
			</ol>
		</li>
	</ol>

	#for $sname, $eventlist in $events.iteritems()
		<ol class="channel-listing">
			<li>
				<span class="ui-widget-header">
					<div>
						<h2 class="picon" ><img src="$(picons[$sname])" title="$sname" /></h2>
						<span>$sname</span>
					</div>
				</span>
				<ol cass="eventlist">
					#set $c=0
					#set $ref = ''
					#for $event in $eventlist[0]
					#set pad = 0
					#if $c == 0
						#set $ref = quote(event['ref'], safe=' ~@#$&()*!+=:;,.?/\'')
						#set pad = 141 + ($event.begin_timestamp - $first) / 6
						<li class="event" style=;width:${pad}px;">
						</li>
					#end if
					#set $end = $event.begin_timestamp + $event.duration
					#set $iscurr = ""
					#if $event.begin_timestamp < $now and $end > $now
						#set $iscurr = " ui-state-hover"
					#end if
					<li class="event" data-ref="$ref" data-id="${event.id}" style="width:${event.duration/6}px;" >
						<a href="#" class="ui-widget-content ${iscurr}" title="$event['title']">
						<span class="ename">$event['title']</span>
						<span class="etime">
						<span>$strftime("%H:%M", $localtime($event['begin_timestamp']))
						</span>
						</span>
						</a>
					</li>
					#set $c = $c + 1
					#end for
				</ol>
			</li>
		</ol>
	#end for
</div>
#end if
</div>
<div id="eventdescription"></div>

<script>
#if $mode == 2
var opena = $first;
var openb = $now;
var pos = (openb - opena);
if (pos>0)
	pos = pos / 6;

#if $day == 0

\$(".timetable-now").css('left',151+pos);

setTimeout(function() {
	var nowdate = Math.round(+new Date()/1000);
	var pos = (nowdate - opena);
	if(pos>0)
		pos = pos / 6;
	\$(".timetable-now").css('left',151+pos);
} ,10000);

\$(".timetable-now").css('height',\$("#tblinner").height());

#else

\$(".timetable-now").css('height','0');

#end if

#end if
var picons = $dumps($picons);
var reloadTimers = false;
function getScrollBarWidth () {
	var \$outer = \$('<div>').css({visibility: 'hidden', width: 100, overflow: 'scroll'}).appendTo('body'),
		widthWithScroll = \$('<div>').css({width: '100%'}).appendTo(\$outer).outerWidth();
	\$outer.remove();
	return 100 - widthWithScroll;
}
var scrollBarWidth=getScrollBarWidth();
function fixTableHeight() {
	var addScrollBarWidth = scrollBarWidth;
	if (\$('#tbl1').width() <= \$("#tvcontent").width()){
		addScrollBarWidth = 0;
	}
	
#if $mode == 1
	\$("#tbl1body").height( (\$("#tvcontent").height() - \$("#navepg").height() - 2*\$("#tbl1 thead").height() - addScrollBarWidth - 2) + "px");
#else
	\$("#tbl1body").height( (\$("#tvcontent").height() - \$("#navepg").height() - 20 - addScrollBarWidth - 2) + "px");
#end if
	if (!\$('#toolbar-header').is(':visible')) { 
		var dh = \$(window).height();
		\$("#tvcontentmain").height(dh-80);
		\$("#tbl1body").height(dh-215);
	}
}
fixTableHeight();
\$(window).resize(function(){ fixTableHeight(); });
\$(".bq").click(function() {
	var id = \$(this).data("ref");
	\$("#tvcontent").html(loadspinner).load('../ajax/multiepg?bref='+id);
	if(typeof(Storage) !== "undefined") { localStorage.lastmbq = id; }
});
\$(".event").click(function() {
	var id = \$(this).data("id");
	if (id != undefined) {
		var ref = \$(this).data("ref");
		\$("#eventdescription").load('../ajax/event?idev='+id+'&sref='+escape(ref), function() { 
			\$("#eventdescription").show(200).draggable( { handle: ".handle" } );
		});
	}
});
\$(".plus").click(function() {
	var day = \$(this).data("day");
	\$("#tvcontent").html(loadspinner).load('../ajax/multiepg?bref=${quote($bref)}&day='+day);
});
if(!timeredit_initialized)
	\$('#editTimerForm').load('../ajax/edittimer');
if(\$("#header").is(':hidden')) { 
	\$('#compressmepg').show();
	\$('#refreshmepg').show();
}
if(mepgdirect==1) {
	mepgdirect=0;
	\$("#expandmepg").click();
}
</script>

