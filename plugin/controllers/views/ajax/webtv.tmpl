#filter WebSafe
#from Plugins.Extensions.OpenWebif.local import tstrings
<style>
#streamchannels-menu {
	max-height: 300px;
}
.overflow{ height:200px;}
</style>
<div id="content_main" style="min-height: 500px;background-image:none;" class="ui-widget-content">
	<div id="info">
	<div style="display: inline-block; width: 100%; zoom: 1;background-image:none;" class="ui-widget-content">
		<h3 class="ui-widget-header">Player</h3>
				<div id="vlcPlayer" style="margin:0 auto 0 auto;width:640px;height:400px;">
					<embed type="application/x-vlc-plugin" pluginspage="http://www.videolan.org" version="VideoLAN.VLCPlugin.2" width="640px" height="360px" id="vlc"></embed>
				</div>
				<div id="htmlPlayer" style="margin:0 auto 0 auto;width:640px;height:400px;">
				<video id="htmlp" width="640" height="360" controls>
				</video>
				</div>
				#if $vxgenabled
				<div id="vxgPlayer" style="margin:0 auto 0 auto;width:640px;height:500px;">
				</div>
				#end if
				<div style="display:table;margin-bottom:10px;width: 95%;">
					<div style="display:table-cell;">
					Channel: <select name="streamchannels" id="streamchannels" tabindex="16"></select>
					</div>
					<div style="display:table-cell;">
					Recordings: <select name="streamrecordings" id="streamrecordings" tabindex="10"></select>
					</div>
				</div>
				<div style="display:table;margin-bottom:10px;width: 95%;">
					<div style="display:inline-block;">
						<div id="Deinterlace">
							Deinterlace: <select id="deinterlace">
								<option value="off">Off</option>
								<option value="blend">Blend</option>
								<option value="bob">Bob</option>
								<option value="discard">Discard</option>
								<option value="linear">Linear</option>
								<option value="mean">Mean</option>
								<option value="x">X</option>
								<option value="yadif">Yadif</option>
								<option value="yadif2x">Yadif2x</option>
							</select>
						</div>
						<label for="vlcautoplay">Autoplay:</label>
						<input type="checkbox" name="vlcautoplay" id="vlcautoplay" value="" class="checkbox ui-widget-content ui-corner-all">
						#if $transcoder_port <> 0
						<label for="transcoding">Transcoding:</label>
						<input type="checkbox" name="transcoding" id="transcoding" value="" class="checkbox ui-widget-content ui-corner-all">
						#end if
						Player: <select id="webtvplayer">
								<option value="vlc">VLC</option>
								<option value="vxg">VXG</option>
								<option value="html">HTML5</option>
							</select>
						
						<button id="btnstop">Stop</button>
						<button id="btnplay">Play</button>
					</div>
				</div>
				
			</div>
		</div>
<script type="text/javascript" src="/js/chosen.jquery.min.js"></script>
#if $vxgenabled
<script type="text/javascript" src="/js/vxgplayer-1.8.11.min.js"></script>
#end if
<script>
var isChrome = !!window.chrome && !!window.chrome.webstore;
var isFirefox = typeof InstallTrigger !== 'undefined';

(function() {

	var PlayerObj = function () {
		var self;
		var _vlc;
		var _html;
		var vxgplayerId = null;
		var currentp;
		return {
			setup: function () {
				self = this;
				
				if (isChrome)
					\$("#webtvplayer option[value='vlc']").remove();
#if $vxgenabled
				if (isFirefox)
					\$("#webtvplayer option[value='vxg']").remove();
#else
				\$("#webtvplayer option[value='vxg']").remove();
#end if

				\$("#streamchannels").chosen({disable_search_threshold: 10,no_results_text: "Oops, nothing found!",width: "400px"});
				\$("#streamchannels").chosen().change( 
					function() {
						self.setUrl(\$("#streamchannels").val(),\$("#streamchannels option:selected").text(),true);
						self.play();
					}
				);
				
				\$("#streamrecordings").chosen({disable_search_threshold: 10,no_results_text: "Oops, nothing found!",width: "300px"});
				\$("#streamrecordings").chosen().change( 
					function() {
						var ref = \$("#streamrecordings").val();
						var name = \$("#streamrecordings option:selected").text();
						if(ref!='')
						{
							if(ref == name)
							{
								\$("#streamrecordings").empty();
								\$('#streamrecordings').trigger("chosen:updated");
								self.getRecordings(ref,function(){
									\$('#streamrecordings').trigger("chosen:updated");
								});
							}
							else {
								self.setUrl(ref,name,false);
								self.play();
							}
						}
					}
				);
				
				\$("#deinterlace").chosen({disable_search: true,no_results_text: "",width: "300px"});
				\$("#deinterlace").chosen().change( 
						function() {
							var dv = \$("#deinterlace").val();
							SetLSValue('vlcdeinterlace',dv);
							self.setDeinterlace(dv);
						}
				);

				\$("#webtvplayer").chosen({disable_search: true,no_results_text: "",width: "300px"});
				\$("#webtvplayer").chosen().change( 
						function() {
							var dv = \$("#webtvplayer").val();
							SetLSValue('webtvplayer',dv);
							self.setPlayer(dv);
						}
				);
				var pl = GetLSValue('webtvplayer','vlc');
				\$("#webtvplayer").val( pl );
				\$('#webtvplayer').trigger("chosen:updated");
				self.setPlayer(pl);

				var dv = GetLSValue('vlcdeinterlace','off');
				\$("#deinterlace").val( dv );
				\$('#deinterlace').trigger("chosen:updated");
				self.setDeinterlace(dv);
				
				self.getAllServices(function() 
					{
						if(current_ref) {
							\$("#streamchannels").val( current_ref );
						}
						\$('#streamchannels').trigger("chosen:updated");
					}
				);
				self.getRecordings('',function(){
					\$('#streamrecordings').trigger("chosen:updated");
				});
				
				\$(".chosen-container .chosen-drop").addClass('ui-widget-content');
				if (theme == 'eggplant' || theme == 'vader')
				{
					\$(".chosen-container .chosen-drop").css('background-image','none');
				}
				
				\$('#btnstop').click(function(){
					self.stop();
				});
				\$('#btnplay').click(function(){
					self.play();
				});
				
				if(current_ref) {
					self.setUrl(current_ref,current_name,true);
					if (\$('#autoplay').is(':checked') === true)
						self.play();
				}

				\$('#vlcautoplay').click(function() { 
					SetLSValue('vlcautoplay',\$('#vlcautoplay').is(':checked'));
				});
				var ap = GetLSValue('vlcautoplay',false);
				\$('#vlcautoplay').prop('checked',ap);
#if $transcoder_port <> 0
				\$('#webtvtranscoding').click(function() { 
					SetLSValue('webtvtranscoding',\$('#webtvtranscoding').is(':checked'));
				});
				var ap = GetLSValue('webtvtranscoding',false);
				\$('#webtvtranscoding').prop('checked',ap);
#end if
			},isInArray: function(array, search) { 
				return (array.indexOf(search) >= 0) ? true : false; 
			},getAllServices: function(callback) {
				\$.getJSON( "/api/getallservices", function( data ) {
					var bqs = data['services'];
					var options = "";
					var refs = [];
					\$.each( bqs, function( key, val ) {
						var name = val['servicename'];
						var slist = val['subservices'];
						var items = [];
						\$.each( slist, function( key, val ) {
							var ref = val['servicereference']
							if (!self.isInArray(refs,ref)) {
								refs.push(ref);
								if(ref.substring(0, 4) == "1:0:" || ref.substring(0, 7) == "1:134:1")
									items.push( "<option value='" + ref + "'>" + val['servicename'] + "</option>" );
							}
						});
						if (items.length>0) {
							options += "<optgroup label='" + name + "'>" + items.join("") + "</optgroup>";
						}
					});
					\$("#streamchannels").append( options);
					callback();
				});
			},getRecordings: function(_dirname,callback) {
				var rdata = {};
				if(_dirname != '')
					rdata = {dirname: _dirname};
				\$.ajax({
					url: '/api/movielist',
					dataType: 'json',
					cache: false,
					data: rdata,
					success: function ( data ) {
						var mv = data['movies'];
						var dn = data['directory'];
						var subdirs = data['bookmarks'];
						var items = [];
						var lastdir = '';
						var dira = dn.split('/');
						var options='';
						if(dira.length>1) {
							for (index = 0;index < dira.length - 2; ++index) {
								lastdir += dira[index] + '/';
							}
						}
						if(lastdir!='') {
							options = "<optgroup label='Folders'>";
							options += "<option value='' disabled selected style='display:none;'></option>";
							options += "<option value='" + lastdir + "'>" + lastdir + "</option>";
							for (index = 0;index < subdirs.length - 1; ++index) {
								options += "<option value='" + dn + subdirs[index] + "'>" + dn + subdirs[index] + "</option>";
							}
							options += "</optgroup>";
						}
						
						
						$.each( mv, function( key, val ) {
							var ref = val['filename'];
							var name =  val['eventname'];
							items.push( "<option value='" + ref + "'>" + name + "</option>" );
						});
						options += "<optgroup label='" + dn + "'>" + items.join("") + "</optgroup>";
						\$("#streamrecordings").append( options );
						callback();
					}
				});
			}, setDeinterlace: function(val){
					var modes = ["blend", "bob", "discard", "linear", "mean", "x", "yadif", "yadif2x"];
					try {
						if(val != "off" && modes.indexOf(val) >= 0)
							self._vlc.video.deinterlace.enable(val);
						else
							self._vlc.video.deinterlace.disable();
					} catch (e) {
					}
			}, setUrl: function(sref,name,live) {

				try {
					
					if($transcoder_port != 0 && \$('#webtvtranscoding').is(':checked'))
					{
						url = 'http://' + window.location.hostname + ':$transcoder_port/' + sref;
					}
					else
					{
						if (live)
							url = 'http://' + window.location.hostname + ':8001/' + sref;
						else
							url = '/file?file=' + sref;
					}
					
					if(self._vlc) {
						self._vlc.playlist.clear();
						self._vlc.playlist.add(url);
					}
					if(self._html) {
						self._html.src = url;
					}
#if $vxgenabled
					if(self.currentp == 'vxg')
						vxgplayer(self.vxgplayerId).src(url);
#end if
				} catch (e) {
				}
			}, stop: function() {
#if $vxgenabled
				if(self.currentp == 'vxg')
					vxgplayer(self.vxgplayerId).stop();
#end if
				if(self.currentp == 'vlc')
					try { self._vlc.playlist.stop(); } catch (e) { }
				if(self.currentp == 'html')
					try { self._html.stop(); } catch (e) { }
			}, play: function() {
#if $vxgenabled
				if(self.currentp == 'vxg')
					vxgplayer(self.vxgplayerId).play();
#end if
				if(self.currentp == 'vlc')
					try { self._vlc.playlist.play(); } catch (e) { }
				if(self.currentp == 'html')
					try { self._html.play(); } catch (e) { }
			}, setPlayer : function (pl) {
				self._vlc = null;
				self._html = null;
				\$('#vlcPlayer').hide();
#if $vxgenabled
				\$('#vxgPlayer').hide();
#end if
				\$('#htmlPlayer').hide();
				self.currentp = pl;
				
				if(pl == 'vlc'){
					self._vlc = document.getElementById("vlc");
					\$('#Deinterlace').show();
					\$('#vlcPlayer').show();
				}
				else
					\$('#Deinterlace').hide();
				
				if(pl == 'html'){
					self._html = document.getElementById("htmlp");
					\$('#htmlPlayer').show();
				}
#if $vxgenabled
				if(pl == 'vxg'){
					if(!vxgplayerId)
						self.createVX();
					\$('#vxgPlayer').show();
				}
			}, createVX: function() {
			
				self.vxgplayerId = 'vxg_media_player1';
				var div = document.createElement('div');
				div.setAttribute("id", self.vxgplayerId);
				div.setAttribute("class", "vxgplayer");
				var _parent = document.getElementById('vxgPlayer');
				_parent.appendChild(div);
				vxgplayer(self.vxgplayerId, {
					nmf_path: 'media_player.nmf',
					nmf_src: '/js/media_player.nmf',
					latency: 300000,
					aspect_ratio_mode: 1,
					autohide: 3,
					controls: true,
					avsync: true,
					autoreconnect: 1
				});
#end if
			},
		}
	};

	var playerobj = new PlayerObj();
	playerobj.setup();

})();
</script>
<link rel="stylesheet" type="text/css" href="/css/chosen.min.css" />
#if $vxgenabled
<link rel="stylesheet" type="text/css" href="/css/vxgplayer-1.8.11.min.css" />
<style>
.vxgplayer-error { margin-left:0px;}
</style>
#end if
#end filter